name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    name: Create Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for full git history

      - name: Create Release
        id: release
        uses: ./  # Use the local action
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          version-prefix: 'v'
          initial-version: '0.1.0'
          changelog-path: './CHANGELOG.md'

      - name: Verify Version Output
        if: steps.release.outputs.version-tag != ''
        run: |
          VERSION_TAG="${{ steps.release.outputs.version-tag }}"
          echo "Verifying version-tag output: $VERSION_TAG"

          # Extract prefix (everything before first digit) and validate semver format
          if [[ "$VERSION_TAG" =~ ^([^0-9]*)([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            PREFIX="${BASH_REMATCH[1]}"
            SEMVER="${BASH_REMATCH[2]}"
            echo "‚úÖ Version tag format is valid: $VERSION_TAG"
            echo "   Prefix: '${PREFIX}' | Semver: ${SEMVER}"
          else
            echo "‚ö†Ô∏è WARNING: Version tag does not match expected semver format (<prefix>X.X.X)"
            echo "   Actual: $VERSION_TAG"
            echo "   Expected pattern: <prefix>X.X.X (e.g., v1.2.3 or release-1.2.3)"
          fi

      - name: Display Release Info
        if: steps.release.outputs.release-created == 'true'
        run: |
          echo "üöÄ Release Created!"
          echo "Version: ${{ steps.release.outputs.version }}"
          echo "Tag: ${{ steps.release.outputs.version-tag }}"
          echo "Release URL: ${{ steps.release.outputs.release-url }}"
          echo ""
          echo "üìä Statistics:"
          echo "  Total Commits: ${{ steps.release.outputs.commit-count }}"
          echo "  Added: ${{ steps.release.outputs.added-count }}"
          echo "  Changed: ${{ steps.release.outputs.changed-count }}"
          echo "  Deprecated: ${{ steps.release.outputs.deprecated-count }}"
          echo "  Removed: ${{ steps.release.outputs.removed-count }}"
          echo "  Fixed: ${{ steps.release.outputs.fixed-count }}"
          echo "  Security: ${{ steps.release.outputs.security-count }}"

      - name: Update Major Version Tag
        if: steps.release.outputs.release-created == 'true'
        run: |
          VERSION_TAG="${{ steps.release.outputs.version-tag }}"
          echo "Processing version tag: $VERSION_TAG"

          # Extract prefix and major version (e.g., v1.2.3 -> v + 1, release-2.3.4 -> release- + 2)
          if [[ "$VERSION_TAG" =~ ^([^0-9]*)([0-9]+)\.[0-9]+\.[0-9]+$ ]]; then
            PREFIX="${BASH_REMATCH[1]}"
            MAJOR="${BASH_REMATCH[2]}"
            MAJOR_VERSION="${PREFIX}${MAJOR}"
            echo "Extracted major version: $MAJOR_VERSION (prefix: '${PREFIX}', major: ${MAJOR})"

            # Configure git
            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            # Force-update the major version tag to point to the release tag
            # This is standard practice for GitHub Actions to allow users to reference @v1
            # Users can reference either the major version tag for automatic updates or specific release tags for pinned versions
            echo "Updating $MAJOR_VERSION to point to $VERSION_TAG"
            git tag -f "$MAJOR_VERSION" "$VERSION_TAG"
            git push -f origin "$MAJOR_VERSION"

            echo "‚úÖ Successfully updated $MAJOR_VERSION tag"
          else
            echo "‚ùå ERROR: Version tag does not match expected semver format (<prefix>X.X.X)"
            echo "   Actual: $VERSION_TAG"
            echo "   Cannot extract major version for tag update"
            exit 1
          fi

      - name: No Release Created
        if: steps.release.outputs.version-bump-type == 'none'
        run: |
          echo "‚ÑπÔ∏è No version bump detected - no release created"
          echo "This usually means no commits with version-bumping types were found since the last release."
